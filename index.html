<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ä¿å­˜ã§ãã‚‹æ¤ç‰©å›³é‘‘ãƒãƒƒãƒ—</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        #map { height: 100vh; width: 100%; }
        body { margin: 0; }
    </style>
</head>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <style>
        /* å³ä¸Šã®ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ */
        #add-button {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            background: #28a745;
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç°¡æ˜“ç‰ˆï¼‰ */
        #form-container {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            z-index: 2000;
            border-radius: 10px;
            width: 90%; max-width: 400px;
        }
    </style>

    <button id="add-button">+</button>

    <div id="form-container">
        <h3>æ¤ç‰©ã‚’ç™»éŒ²</h3>
        <input type="text" id="p-name" placeholder="åå‰">
        <textarea id="p-desc" placeholder="èª¬æ˜"></textarea>
        <input type="file" id="p-file" accept="image/*">
        <p id="location-status" style="font-size: 12px; color: gray;"></p>
        <button onclick="savePlant()">ä¿å­˜</button>
        <button onclick="closeForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
<body>
    <div id="map"></div>

    <script>
        // --- è¨­å®šã‚¨ãƒªã‚¢ (ãƒ‡ãƒ¼ã‚¿ã®ä¿ç®¡å ´æ‰€ã€ã‚«ã‚®) ---
        const SUPABASE_URL = 'https://wvrzhcjjzwcanjyersit.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Bgu4CKgwP8DuK630PlQl8g_zYUXRiLk';
        // ------------------------------------

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
        const map = L.map('map').setView([35.14258, 137.08703], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 1. ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€éƒ¨åˆ†
        async function loadPlants() {
            console.log("èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã™..."); // 1. å‹•ãå‡ºã—ãŸã‹ç¢ºèª
            const { data, error } = await supabaseClient.from('plants').select('*');
            if (error) {
                console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:", error.message);
                return;
            }
            console.log("å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:", data); // 2. ã“ã“ã§ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã‚’ãƒã‚§ãƒƒã‚¯ï¼
            if (data && data.length > 0) {
                data.forEach(plant => {
                    console.log(plant.name + "ã‚’è¡¨ç¤ºã—ã¾ã™", plant.lat, plant.lng);
                    L.marker([plant.lat, plant.lng])
                        .addTo(map)
                        .bindPopup(plant.name);
                });
            } else {
                console.log("ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã€ã¾ãŸã¯ç©ºã£ã½ã§ã™ã€‚"); // 3. ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            }
        }
        loadPlants();

        // 2. åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã™ã‚‹éƒ¨åˆ†
        map.on('click', async function(e) {
            const name = prompt("æ¤ç‰©ã®åå‰ã¯ä½•ã§ã™ã‹ï¼Ÿ");
            if (name) {
                const { error } = await supabaseClient // ã“ã“ã‚’ä¿®æ­£
                    .from('plants')
                    .insert([{ name: name, lat: e.latlng.lat, lng: e.latlng.lng }]);
        
                if (!error) {
                    L.marker(e.latlng).addTo(map).bindPopup(name).openPopup();
                }
            }
        });

        let selectedCoords = null; // é¸æŠã•ã‚ŒãŸä½ç½®ã‚’ä¸€æ™‚ä¿å­˜ã™ã‚‹å¤‰æ•°

        // 1. ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‹•ã
        document.getElementById('add-button').onclick = () => {
            document.getElementById('form-container').style.display = 'block';
            document.getElementById('location-status').innerText = "å†™çœŸã‚’ãˆã‚‰ã¶ã‹ã€åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã­";
        };

        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
        function closeForm() {
            document.getElementById('form-container').style.display = 'none';
            selectedCoords = null;
        }

        // 2. å†™çœŸãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆä½ç½®æƒ…å ±ã®è§£æï¼‰
        document.getElementById('p-file').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            EXIF.getData(file, function() {
                const lat = EXIF.getTag(this, "GPSLatitude");
                const lng = EXIF.getTag(this, "GPSLongitude");

                if (lat && lng) {
                    // å†™çœŸã«ä½ç½®æƒ…å ±ãŒã‚ã£ãŸå ´åˆï¼ˆåº¦åˆ†ç§’ã‚’åé€²æ³•ã«å¤‰æ›ï¼‰
                    const toDecimal = (gps) => gps[0] + gps[1] / 60 + gps[2] / 3600;
                    selectedCoords = { lat: toDecimal(lat), lng: toDecimal(lng) };
                    document.getElementById('location-status').innerText = "ğŸ“ å†™çœŸã‹ã‚‰ä½ç½®ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸï¼";
                } else {
                    // ä½ç½®æƒ…å ±ãŒãªã„å ´åˆ
                    selectedCoords = null;
                    document.getElementById('location-status').innerText = "âš ï¸ å†™çœŸã«ä½ç½®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åœ°å›³ä¸Šã®å ´æ‰€ã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„";
            
                    // åœ°å›³ã‚’ä¸€åº¦ã ã‘ã‚¯ãƒªãƒƒã‚¯å¾…ã¡çŠ¶æ…‹ã«ã™ã‚‹
                    map.once('click', (ev) => {
                        selectedCoords = { lat: ev.latlng.lat, lng: ev.latlng.lng };
                        document.getElementById('location-status').innerText = "ğŸ“ åœ°å›³ã‹ã‚‰ä½ç½®ã‚’æŒ‡å®šã—ã¾ã—ãŸ";
                        // ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´æ‰€ã«ä¸€æ™‚çš„ãªãƒãƒ¼ã‚«ãƒ¼ã‚’ç½®ãã¨åˆ†ã‹ã‚Šã‚„ã™ã„
                        L.marker(ev.latlng).addTo(map).bindPopup("ã“ã“ã«è¿½åŠ ã—ã¾ã™").openPopup();
                    });
                }
            });
        };

        // 3. ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
        async function savePlant() {
            const name = document.getElementById('p-name').value;
            const desc = document.getElementById('p-desc').value;
            const file = document.getElementById('p-file').files[0];

            if (!name || !selectedCoords) {
                alert("åå‰ã¨ä½ç½®æƒ…å ±ãŒå¿…è¦ã§ã™ï¼");
                return;
            }

            let imageUrl = "";

            // å†™çœŸãŒã‚ã‚Œã°Supabase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            if (file) {
                const fileName = `${Date.now()}_${file.name}`;
                const { data, error: uploadError } = await supabaseClient.storage
                    .from('plant-photos')
                    .upload(fileName, file);

                if (uploadError) {
                    alert("å†™çœŸã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—: " + uploadError.message);
                    return;
                }

                // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸå†™çœŸã®å…¬é–‹URLã‚’å–å¾—
                const { data: urlData } = supabaseClient.storage
                    .from('plant-photos')
                    .getPublicUrl(fileName);
                imageUrl = urlData.publicUrl;
            }

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
            const { error: dbError } = await supabaseClient.from('plants').insert([{
                name: name,
                description: desc,
                image_url: imageUrl,
                lat: selectedCoords.lat,
                lng: selectedCoords.lng
            }]);

            if (dbError) {
                alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + dbError.message);
            } else {
                alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
                location.reload(); // ç”»é¢ã‚’æ›´æ–°ã—ã¦ãƒ”ãƒ³ã‚’è¡¨ç¤º
            }
        }

    </script>
    // --- èª­ã¿è¾¼ã¿æ©Ÿèƒ½ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ ---
    async function loadPlants() {
        const { data, error } = await supabaseClient.from('plants').select('*');
        if (error) {
            console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error.message);
            return;
        }

        if (data) {
            data.forEach(plant => {
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ä¸­èº«ã‚’ä½œæˆï¼ˆå†™çœŸãŒã‚ã‚Œã°è¡¨ç¤ºï¼‰
                let popupContent = `<b>${plant.name}</b><br>${plant.description || 'èª¬æ˜ãªã—'}`;
                if (plant.image_url) {
                    popupContent += `<br><img src="${plant.image_url}" style="width:100%; max-width:200px; margin-top:5px;">`;
                }

                L.marker([plant.lat, plant.lng])
                    .addTo(map)
                    .bindPopup(popupContent);
            });
        }
    }
    loadPlants();

    // --- ä¿å­˜æ©Ÿèƒ½ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆåå‰ãƒ»èª¬æ˜ãƒ»å†™çœŸURLï¼‰ ---
    map.on('click', async function(e) {
        const name = prompt("æ¤ç‰©ã®åå‰ã¯ä½•ã§ã™ã‹ï¼Ÿ");
        if (!name) return;

        const description = prompt("æ¤ç‰©ã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        const imageUrl = prompt("å†™çœŸã®URLãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã§ã‚‚OKï¼‰");

        // Supabaseã«ä¿å­˜ï¼ˆdescriptionã¨image_urlã‚‚è¿½åŠ ï¼‰
        const { error } = await supabaseClient
            .from('plants')
            .insert([{ 
                name: name, 
                description: description,
                image_url: imageUrl,
               lat: e.latlng.lat, 
                lng: e.latlng.lng 
            }]);
    
        if (!error) {
            let popupContent = `<b>${name}</b><br>${description || ''}`;
            if (imageUrl) {
                popupContent += `<br><img src="${imageUrl}" style="width:200px;">`;
            }
            L.marker(e.latlng).addTo(map).bindPopup(popupContent).openPopup();
        } else {
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
        }
    });
</body>
</html>
